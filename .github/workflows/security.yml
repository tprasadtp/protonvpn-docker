name: security
on:
  workflow_dispatch:
    inputs:
      IMAGE_TAG:
        description: Tag of the image to scan
        required: false
        default: "latest"
        type: string
  schedule:
    - cron: "0 21 * * FRI"
jobs:
  scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        id: trivy
        continue-on-error: true
        run: |
          mkdir -p build/trivy/cache
          mkdir -p build/trivy/output
          docker run --rm \
            --mount "type=bind,src=$(pwd)/build/trivy/cache,dst=/root/.cache" \
            --mount "type=bind,src=$(pwd)/build/trivy/output,dst=/trivy/output" \
            ghcr.io/aquasecurity/trivy:latest \
              image \
              --vuln-type="os" \
              --severity="MEDIUM,HIGH,CRITICAL" \
              --ignore-unfixed \
              --exit-code=5 \
              --format=sarif \
              --output=/trivy/output/trivy.sarif \
              ghcr.io/tprasadtp/protonwire:${IMAGE_TAG:-latest}
        env:
          IMAGE_TAG: ${{ inputs.IMAGE_TAG }}

      - name: Export Trivy Status
        id: trivy-status
        run: |
          if [[ -e /build/trivy/output/trivy.sarif ]]; then
            echo "TRIVY_SARIF=true" >> "$GITHUB_OUTPUT"
            if [[ $TRIVY_STATUS == "failure"  ]]; then
              echo "TRIVY_REBUILD=true" >> "$GITHUB_OUTPUT"
            fi
          fi
        env:
          TRIVY_STATUS: ${{steps.trivy.outcome}}

      - name: Upload Trivy scan results to GitHub Security
        if: github.ref == 'refs/heads/master' && steps.trivy-status.outputs.TRIVY_SARIF == 'true'
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'build/trivy/output/trivy.sarif'
